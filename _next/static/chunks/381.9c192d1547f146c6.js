"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[381],{381:function(t,e,a){a.r(e),a.d(e,{checkCodecSupport:function(){return g},convertToGif:function(){return p},convertToLivp:function(){return u},convertToMp4:function(){return w},convertToWebm:function(){return d},createDownloadLink:function(){return m},forceReleaseMemory:function(){return f},optimizeForLargeFiles:function(){return s},recoverFromError:function(){return h}});let o=null,r=!1,i=!1,n=async()=>{if(void 0!==performance.memory){let t=performance.memory;t.usedJSHeapSize/t.jsHeapSizeLimit>.7&&!i&&(console.warn("内存使用率高，正在尝试释放内存..."),i=!0,await f(),setTimeout(()=>{i=!1},3e5))}},c=async()=>{if(r&&o)return{ffmpeg:o,fetchFile:window._fetchFile};let{createFFmpeg:t,fetchFile:e}=await a.e(45).then(a.t.bind(a,5045,23));if(o)try{o.exit()}catch(t){console.log("FFmpeg 实例释放失败，创建新实例")}return o=t({log:!1,corePath:"http://cdnjs.cloudflare.com/ajax/libs/ffmpeg-core/0.10.0/ffmpeg-core.js"}),await o.load(),r=!0,window._fetchFile=e,{ffmpeg:o,fetchFile:e}},l=async t=>{try{for(let e of t.FS("readdir","/"))if("."!==e&&".."!==e&&"tmp"!==e)try{t.FS("unlink",e)}catch(t){console.log("无法删除文件 ".concat(e,":"),t)}}catch(t){console.log("清理文件系统失败:",t)}},s=async(t,e,a)=>{let o=e.size/1048576;if(o>100){console.log("处理大文件 (".concat(o.toFixed(1),"MB)，正在优化参数..."));let t={...a};return o>500&&(t.quality=Math.min(a.quality,70),("1080p"===a.resolution||"1440p"===a.resolution||"2160p"===a.resolution)&&(t.resolution="720p")),t}return a},p=async(t,e)=>{try{await n();let{ffmpeg:a,fetchFile:o}=await c(),r=await s(a,t,e);await l(a),a.FS("writeFile","input.mp4",await o(t));let i=r.frameRate,p=r.startTime,u=r.duration;await a.run("-i","input.mp4","-ss","".concat(p),"-t","".concat(u),"-vf","fps=".concat(i,",scale=320:-1:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse"),"-loop","0","output.gif");let m=a.FS("readFile","output.gif");return await l(a),new Blob([m.buffer],{type:"image/gif"})}catch(t){console.error("GIF 转换失败:",t),r=!1;try{await f()}catch(t){console.warn("内存释放失败:",t)}throw Error("GIF 转换失败: "+(t.message||"处理视频时出错"))}},u=async function(t,e){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;try{let{ffmpeg:r,fetchFile:i}=await c(),n=t.name.split(".").slice(0,-1).join(".")||"video";o&&o(.1,"准备转换..."),r.FS("writeFile","input.mp4",await i(t));let l=e.startTime||0,s=Math.min(e.duration||3,10);o&&o(.3,"提取视频片段...");let p=l+.5*s;await r.run("-ss",p.toString(),"-i","input.mp4","-vframes","1","-q:v","1","-pix_fmt","yuvj420p","cover.jpg"),o&&o(.5,"处理视频...");let u=Array.from(crypto.getRandomValues(new Uint8Array(16))).map(t=>t.toString(16).padStart(2,"0")).join("");await r.run("-ss",l.toString(),"-t",s.toString(),"-i","input.mp4","-c:v","h264","-profile:v","baseline","-level","3.1","-preset","medium","-pix_fmt","yuv420p","-r","24","-movflags","+faststart+write_colr","-metadata","major_brand=qt  ","-metadata","minor_version=0","-metadata","compatible_brands=qt  ","-metadata","creation_time="+new Date().toISOString(),"-metadata","com.apple.quicktime.content.identifier="+u,"-metadata","com.apple.quicktime.still-image-time=0","-map_metadata","0","video.mov"),o&&o(.7,"创建LIVP包...");let m=new(await a.e(733).then(a.t.bind(a,5733,23))).default,f=r.FS("readFile","cover.jpg"),w=r.FS("readFile","video.mov"),d=new Date,g=d.getFullYear().toString()+(d.getMonth()+1).toString().padStart(2,"0")+d.getDate().toString().padStart(2,"0"),h=d.getHours().toString().padStart(2,"0")+d.getMinutes().toString().padStart(2,"0")+d.getSeconds().toString().padStart(2,"0"),b="IMG_".concat(g,"_").concat(h);m.file("".concat(b,".JPG"),f),m.file("".concat(b,".MOV"),w);let y=JSON.stringify({version:1,type:"com.apple.live-photo",photoDate:new Date().toISOString(),duration:s,assetIdentifier:u,stillImageTime:.5,fps:24});m.file("metadata.json",y);let v=await m.generateAsync({type:"blob",compression:"DEFLATE"});o&&o(.9,"完成...");try{r.FS("unlink","input.mp4"),r.FS("unlink","cover.jpg"),r.FS("unlink","video.mov")}catch(t){console.log("清理文件失败",t)}return o&&o(1,"转换完成"),new File([v],"".concat(n,".livp"),{type:"application/zip"})}catch(t){throw console.error("LIVP 转换失败:",t),Error("LIVP 转换失败: "+(t.message||"创建实况照片时出错"))}},m=(t,e)=>{let a="string"==typeof t?t:URL.createObjectURL(t),o=document.createElement("a");return o.href=a,o.download=e,{url:a,link:o}},f=async()=>{if(o)try{await l(o);try{o.exit()}catch(t){console.log("FFmpeg 实例退出失败，将重置实例")}o=null,r=!1,window.gc?window.gc():Array(100).fill().map(()=>Array(1e6).fill(0)).length=0,"undefined"!=typeof URL&&"function"==typeof URL.revokeObjectURL&&console.log("提示: 请确保手动释放所有 Blob URLs")}catch(t){console.error("强制释放内存失败:",t)}},w=async(t,e)=>{try{let a;await n();let{ffmpeg:o,fetchFile:r}=await c();await l(o),o.FS("writeFile","input.mp4",await r(t));let i=Math.floor(31-e.quality/100*30),s=e.startTime,p=e.duration;switch(e.resolution||"720p"){case"360p":a="scale=-2:360";break;case"480p":a="scale=-2:480";break;case"720p":default:a="scale=-2:720";break;case"1080p":a="scale=-2:1080";break;case"1440p":a="scale=-2:1440";break;case"2160p":a="scale=-2:2160";break;case"original":a="scale=iw:ih";break;case"custom":let u=e.customWidth||1280,m=e.customHeight||720;a="scale=".concat(u,":").concat(m,":force_original_aspect_ratio=decrease,pad=").concat(u,":").concat(m,":(ow-iw)/2:(oh-ih)/2")}await o.run("-i","input.mp4","-ss","".concat(s),"-t","".concat(p),"-c:v","libx264","-crf","".concat(i),"-preset","fast","-vf",a,"-pix_fmt","yuv420p","-movflags","+faststart","-c:a","aac","-b:a","128k","output.mp4");let f=o.FS("readFile","output.mp4");return await l(o),new Blob([f.buffer],{type:"video/mp4"})}catch(t){throw console.error("MP4 转换失败:",t),r=!1,Error("MP4 转换失败: "+(t.message||"处理视频时出错"))}},d=async(t,e)=>{try{let a;await n();let{ffmpeg:o,fetchFile:r}=await c();await l(o),o.FS("writeFile","input.mp4",await r(t));let i=Math.floor(31-e.quality/100*30),s=e.startTime,p=e.duration;switch(e.resolution||"720p"){case"360p":a="scale=-2:360";break;case"480p":a="scale=-2:480";break;case"720p":default:a="scale=-2:720";break;case"1080p":a="scale=-2:1080";break;case"1440p":a="scale=-2:1440";break;case"2160p":a="scale=-2:2160";break;case"original":a="scale=iw:ih";break;case"custom":let u=e.customWidth||1280,m=e.customHeight||720;a="scale=".concat(u,":").concat(m,":force_original_aspect_ratio=decrease,pad=").concat(u,":").concat(m,":(ow-iw)/2:(oh-ih)/2")}await o.run("-i","input.mp4","-ss","".concat(s),"-t","".concat(p),"-c:v","libvpx-vp9","-crf","".concat(i),"-b:v","0","-deadline","good","-cpu-used","2","-vf",a,"-c:a","libopus","-b:a","128k","output.webm");let f=o.FS("readFile","output.webm");return await l(o),new Blob([f.buffer],{type:"video/webm"})}catch(t){throw console.error("WebM 转换失败:",t),r=!1,Error("WebM 转换失败: "+(t.message||"处理视频时出错"))}},g=async()=>{try{let{ffmpeg:t}=await c();await t.run("-encoders");let e=t._LAST_COMMAND_STDOUT.includes("libvpx-vp9"),a=t._LAST_COMMAND_STDOUT.includes("libx264");return{webm:e,mp4:a,gif:!0,livp:a}}catch(t){return console.error("编解码器检查失败:",t),{webm:!1,mp4:!0,gif:!0,livp:!0}}},h=async()=>{console.log("正在尝试从错误中恢复..."),await f();try{let{createFFmpeg:t,fetchFile:e}=await a.e(45).then(a.t.bind(a,5045,23));return o=t({log:!1,corePath:"http://cdnjs.cloudflare.com/ajax/libs/ffmpeg-core/0.10.0/ffmpeg-core.js"}),await o.load(),r=!0,window._fetchFile=e,console.log("FFmpeg 已成功重新初始化"),!0}catch(t){return console.error("FFmpeg 重新初始化失败:",t),!1}}}}]);